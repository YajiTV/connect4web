{{define "board"}}
    <!doctype html>
    <html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Board {{.Code}}</title>
        <link rel="stylesheet" href="/static/css/base.css">
        <link rel="stylesheet" href="/static/css/board.css">
        <link rel="stylesheet" href="/static/css/util.css">
        <meta name="color-scheme" content="light dark">
        {{if .IsNewMove}}
            <meta http-equiv="refresh" content="1.2;url=/board/{{.Code}}?rev={{.Rev}}">
        {{else}}
            <meta http-equiv="refresh" content="0;url=/board/{{.Code}}?rev={{.Rev}}">
        {{end}}
    </head>
    <body class="px-0 bg-transparent" style="margin:0;padding:var(--pad);">
    {{if not .Ready}}
        <p class="status">Waiting for a second player</p>
    {{else}}
        {{if .Over}}
            {{if eq .Winner 0}}<p class="status">Draw</p>{{end}}
            {{if eq .Winner 1}}<p class="victory">Win {{.P1Name}}</p><div class="confetti-container"></div>{{end}}
            {{if eq .Winner 2}}<p class="victory">Win {{.P2Name}}</p><div class="confetti-container"></div>{{end}}
            {{if .Forfeit}}<p class="status">{{.Forfeit}}</p>{{end}}
            <div class="controls place-center gap-16 mt-16 mb-20">
                <p class="status m-0">
                    Rematch:
                    {{if .RematchP1}}P1 ready{{else}}P1 waiting{{end}} —
                    {{if .RematchP2}}P2 ready{{else}}P2 waiting{{end}}
                </p>
                {{if and (eq .Self 1) (not .RematchP1)}}
                    <form action="/rematch/{{.Code}}" method="post" target="board" class="mb-12">
                        <button class="btn" type="submit">Accept rematch</button>
                    </form>
                {{end}}
                {{if and (eq .Self 2) (not .RematchP2)}}
                    <form action="/rematch/{{.Code}}" method="post" target="board" class="mb-12">
                        <button class="btn" type="submit">Accept rematch</button>
                    </form>
                {{end}}
            </div>
        {{else}}
            <div class="hud mb-12">
                <div class="player"><span class="player-badge p1"></span><span class="player-name">{{.P1Name}}</span></div>
                <div class="turn-badge">
                    <span class="turn-dot" style="{{if (eq .NextPlayer 1)}}background: var(--p1){{else}}background: var(--p2){{end}}"></span>
                    {{if eq .NextPlayer 1}}Turn {{.P1Name}}{{end}}
                    {{if eq .NextPlayer 2}}Turn {{.P2Name}}{{end}}
                </div>
                <div class="player right"><span class="player-name">{{.P2Name}}</span><span class="player-badge p2"></span></div>
            </div>
            <iframe title="Clock" name="clock" src="/clock/{{.Code}}" class="w-full h-44 mb-14 rounded-16 shadow-2 bg-transparent" style="border:0;"></iframe>
        {{end}}
    {{end}}

    <div class="game-wrap mt-16">
        <form action="/play/{{.Code}}" method="post" target="board">
            <div class="board-shell">
                <div class="game-board {{if and .CanPlay (not .Over)}}{{if (eq .NextPlayer 1)}}p1-turn{{else}}p2-turn{{end}}{{end}}">
                    {{range $colIndex := Iterate 7}}
                        {{$next := NextEmptyRow $.Grid $colIndex}}
                        <div class="column-wrapper">
                            <button class="column-btn" type="submit" name="column" value="{{$colIndex}}" {{if or (not $.Ready) $.Over (not $.CanPlay) (eq $next -1)}}disabled{{end}} aria-label="Column {{$colIndex}}"></button>
                            {{range $rowIndex := Iterate 6}}
                                {{$cell := index (index $.Grid $rowIndex) $colIndex}}
                                {{if eq $cell 0}}
                                    <div class="cell empty"></div>
                                {{else if eq $cell 1}}
                                    <div class="cell p1 {{if and $.IsNewMove $.HasLast (eq $rowIndex $.LastRow) (eq $colIndex $.LastCol)}}drop{{end}}" {{if and $.IsNewMove $.HasLast (eq $rowIndex $.LastRow) (eq $colIndex $.LastCol)}}style="--row: {{$rowIndex}}; animation-duration: {{DropDuration $rowIndex}}ms"{{end}}></div>
                                {{else if eq $cell 2}}
                                    <div class="cell p2 {{if and $.IsNewMove $.HasLast (eq $rowIndex $.LastRow) (eq $colIndex $.LastCol)}}drop{{end}}" {{if and $.IsNewMove $.HasLast (eq $rowIndex $.LastRow) (eq $colIndex $.LastCol)}}style="--row: {{$rowIndex}}; animation-duration: {{DropDuration $rowIndex}}ms"{{end}}></div>
                                {{end}}
                            {{end}}
                            {{if ge $next 0}}<div class="cell ghost" data-row="{{$next}}"></div>{{end}}
                            {{if and $.IsNewMove $.HasLast (eq $colIndex $.LastCol)}}
                                <div class="cell pending" data-row="{{$.LastRow}}" style="animation-duration: {{DropDuration $.LastRow}}ms"></div>
                            {{end}}
                        </div>
                    {{end}}
                </div>
            </div>
        </form>
    </div>
    </body>
    </html>
{{end}}

{{define "title"}}Power 4 — Game {{.Code}}{{end}}
{{define "content"}}
    <div class="flex items-center justify-between gap-12 mb-12">
        <p class="status m-0">
            {{if .Random}}
                Random match
            {{else}}
                {{if .Reveal}}
                    Code: <span style="font-weight:800;letter-spacing:0.02em">{{.Code}}</span>
                    <a class="header-link" href="/game/{{.Code}}">Hide</a>
                {{else}}
                    Game code hidden
                    <a class="header-link" href="/game/{{.Code}}?reveal=1">Show</a>
                {{end}}
            {{end}}
        </p>
        <a class="btn btn-secondary" href="/">Home</a>
    </div>
    <iframe title="Board" name="board" src="/board/{{.Code}}?rev=0" class="w-full rounded-16 shadow-2 bg-transparent" style="height:740px;border:0;"></iframe>
{{end}}
